<%-include("../../views/partials/admin/main") %>


  <div class="container-fluid" style="width:100% ;">
    <div class="d-flex justify-content-between align-items-center mb-3" style="    padding-left: 50px;">
      <div style="    width: 50%;margin-top: 30px;">
        <h2 class="fw-bold">Coupon Management</h2>
      </div>
    </div>

    <div>
      <div class="col-3" style="float:left ;">
        <!-- Coupon Add Form -->
        <div class="card p-3" style="max-width: 300px;">
          <form id="couponForm" class="card p-3 mb-4">
            <div class="mb-3">
              <label>Coupon Code *</label>
              <input type="text" name="code" class="form-control" >
            </div>
            <div class="mb-3">
              <label>Type *</label>
              <select name="discountType" class="form-control" >
                <option value="percentage">Percentage</option>
                <option value="fixed">Fixed</option>
              </select>
            </div>
            <div class="mb-3">
              <label>Value *</label>
              <input type="number" name="discountValue" class="form-control" >
            </div>
            <div class="mb-3">
              <label>Min Purchase</label>
              <input type="number" name="minPurchase" class="form-control">
            </div>
            <div class="mb-3">
              <label>Expiry Date *</label>
              <input type="date" name="expiryDate" class="form-control" >
            </div>
            <button class="btn btn-success mt-3">Create Coupon</button>

          </form>
        </div>
      </div>




      <div class="col-9" style="float: left;margin-left: 5px;width: 74%;">
        <!-- Table -->
        <div class="table-responsive rounded-4 shadow-sm">

          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Min Purchase</th>
                <th>Expiry</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="couponTable">
              <% coupons.forEach(coupon=> { %>
                <tr data-id="<%= coupon._id %>">
                  <td>
                    <%= coupon.code %>
                  </td>
                  <td>
                    <%= coupon.discountType %>
                  </td>
                  <td>
                    <%= coupon.discountValue %>
                  </td>
                  <td>â‚¹<%= coupon.minPurchase %>
                  </td>
                  <td>
                    <%= coupon.expiryDate.toDateString() %>
                  </td>
                  <td>
                    <button class="btn btn-danger btn-sm delete-coupon">Delete</button>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>


          <div class="mt-3 d-flex justify-content-center">
            <nav>
              <ul class="pagination">
                <% for (let i = 1; i <= totalPages; i++) { %>
                  <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                    <a class="page-link" href="/admin/coupons?page=<%= i %>"><%= i %></a>
                  </li>
                <% } %>
              </ul>
            </nav>
          </div>
          

        </div>

      </div>
    </div>




    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // Create coupon
      document.getElementById("couponForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        const res = await fetch("/admin/coupons/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.success) {
          Swal.fire("Success", result.message, "success").then(() => location.reload());
        } else {
          Swal.fire("Error", result.message, "error");
        }
      });

      // Delete coupon
      document.querySelectorAll(".delete-coupon").forEach(btn => {
        btn.addEventListener("click", async function () {
          const tr = this.closest("tr");
          const id = tr.dataset.id;

          const confirm = await Swal.fire({
            title: "Are you sure?",
            text: "This will permanently delete the coupon",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it!"
          });

          if (confirm.isConfirmed) {
            const res = await fetch(`/admin/coupons/${id}`, { method: "DELETE" });
            const result = await res.json();

            if (result.success) {
              Swal.fire("Deleted!", result.message, "success");
              tr.remove();
            } else {
              Swal.fire("Error", result.message, "error");
            }
          }
        });
      });
    </script>