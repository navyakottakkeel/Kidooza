<%-include("../../views/partials/admin/main") %>




    <div class="container-fluid" style="width:100% ;">
        <div class="d-flex justify-content-between align-items-center mb-3" style="    padding-left: 50px;">
            <div style="    width: 50%;margin-top: 30px;">
                <h2 class="fw-bold">Varients of <%= productName %></h2>
            </div>

            <div>
                <a href="/admin/products">Back to Product Listing Page</a>
            </div>


        </div>

        <div>
            <div class="col-3" style="float:left ;">
                <!-- Varient Add Form -->
                <div class="card p-3" style="max-width: 300px;">
                    

                    <form action="/admin/varients" method="POST">

                        <input type="hidden" name="productId" value="<%= productId %>">
                        <input type="hidden" name="productName" value="<%= productName %>">


                        <div class="mb-3">
                            <label for="size" class="form-label">Size</label>
                            <input type="text" class="form-control" id="size" name="size" />
                        </div>
                        <div class="mb-3">
                            <label for="colour" class="form-label">Colour</label>
                            <input type="text" class="form-control" id="colour" name="colour" />
                        </div>
                        <div class="mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" type="button" onclick="changeStock(-1)">âˆ’</button>
                                <input type="number" class="form-control text-center" id="stock" name="stock" value="0" min="0" />
                                <button class="btn btn-outline-secondary" type="button" onclick="changeStock(1)">+</button>
                              </div>                        </div>
                        <button class="btn" type="submit"
                            style="height:38px;width:230px;background-color:black;color:white;margin-bottom: 10px;">Add
                            New Varient
                            <i class="fas fa-add" style="padding-left: 10px; "></i></button>
                    </form>
                </div>
            </div>




            <div class="col-9" style="float: left;margin-left: 5px;width: 74%;">
                <!-- Table -->
                <div class="table-responsive rounded-4 shadow-sm">
                    <table class="table align-middle text-center table-bordered mb-0" style="width: 100%;">
                        <thead class="text-white" style="background-color: #000;">
                            <tr>
                                <th>Sl.No</th>
                                <th>Size</th>
                                <th>Colour</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <%for( let i=0; i < data.length; i++){%>
                                <tr>
                                    <td>
                                        <%= (currentPage - 1) * 6 + i + 1 %>
                                    </td>
                                    <td><%=data[i].size%></td>
                                    <td><%=data[i].colour%></td>
                                    <td><%=data[i].stock%></td>

                                    <td>
                                        <button onclick="deleteVarient('<%= data[i]._id %>', '<%= productId %>', '<%= productName %>')" class="btn btn-sm"
                                            style="height:38px;width:100px;background-color:red;color:white">Delete</button>

                                            <button class="btn edit-btn"
        style="height:38px;width:100px;background-color:black;color:white"
        data-id="<%= data[i]._id %>"
        data-size="<%= data[i].size %>"
        data-colour="<%= data[i].colour %>"
        data-stock="<%= data[i].stock %>">
  Edit
</button>

                                    </td>
                                    
                                </tr>
                                <%}%>
                        </tbody>
                    </table>


                </div>


                <div class="container">
                    <nav class="mt-3 d-flex justify-content-center">
                      <ul class="pagination">
                        <% for (let i = 1; i <= totalPages; i++) { %>
                          <li class="page-item <%= currentPage == i ? 'active' : '' %>">
                            <a class="page-link" href="/admin/varients?page=<%= i %>">
                              <%= i %>
                            </a>
                          </li>
                        <% } %>
                      </ul>
                    </nav>
                  </div>
                  


            </div>






        </div>


        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


        <script>
document.addEventListener('DOMContentLoaded', function () {
  const editButtons = document.querySelectorAll('.edit-btn');

  editButtons.forEach(button => {
    button.addEventListener('click', async function () {
      const varId = this.dataset.id;
      const currentSize = this.dataset.size;
      const currentColour = this.dataset.colour;
      const currentStock = this.dataset.stock;

      const { value: formValues } = await Swal.fire({
        title: 'Edit Variant',
        html:
          `<input id="swal-input1" class="swal2-input" placeholder="Size" value="${currentSize}">` +
          `<input id="swal-input2" class="swal2-input" placeholder="Colour" value="${currentColour}">` +
          `<input id="swal-input3" type="number" min="0" class="swal2-input" placeholder="Stock" value="${currentStock}">`,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Update',
        preConfirm: () => {
          const size = document.getElementById('swal-input1').value.trim();
          const colour = document.getElementById('swal-input2').value.trim();
          const stock = parseInt(document.getElementById('swal-input3').value);

          if (!size || !colour || isNaN(stock) || stock < 0) {
            Swal.showValidationMessage('Please fill all fields correctly');
            return false;
          }

          return { id: varId, size, colour, stock };
        }
      });

      if (formValues) {
        fetch(`/admin/varients`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formValues)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Variant Updated',
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              location.reload();
            });
          } else {
            Swal.fire('Error!', data.message || 'Update failed', 'error');
          }
        })
        .catch(err => {
          console.error(err);
          Swal.fire('Error!', 'Something went wrong.', 'error');
        });
      }
    });
  });
});



        
  function deleteVarient(varientId) {
    Swal.fire({
      title: 'Are you sure?',
      text: 'Are you want to delete?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'Cancel'
    }).then((result) => {
        console.log("id:",varientId);
      if (result.isConfirmed) {
        fetch(`/admin/varients/${varientId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Deleted!', data.message, 'success').then(() => {
              location.reload(); // refresh to update the list
            });
          } else {
            Swal.fire('Error!', data.message, 'error');
          }
        })
        .catch(err => {
          console.error(err);
          Swal.fire('Error!', 'Something went wrong.', 'error');
        });
      }
    });
  }





            function changeStock(change) {
    const input = document.getElementById('stock');
    let current = parseInt(input.value) || 0;
    current += change;
    if (current < 0) current = 0;
    input.value = current;
  }


        </script>



<% if (success) { %>
    <script>
      Swal.fire({
        icon: 'success',
        title: 'Variant Added',
        text: 'The new variant was added successfully!',
        timer: 2000,
        showConfirmButton: false
      });
    </script>
  <% } %>
  


        <!-- <% if (msg) { %>
            <script>
                Swal.fire({
                    icon: "<%= msg.includes('success') ? 'success' : 'error' %>",
                    title: "<%= msg %>",
                    showConfirmButton: false,
                    timer: 2000
                });
            </script>
            <% } %> -->