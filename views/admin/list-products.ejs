

 <%-include("../../views/partials/admin/main") %>

<style>
    img:hover {
  transform: scale(2);
  transition: 0.3s;
}

.swal2-input,
.swal2-textarea {
  border-radius: 8px;
  border: 1px solid #ccc;
  padding: 10px;
  font-size: 14px;
  box-sizing: border-box;
}

</style>


 <div class="container-fluid" style="width:110% ;">
     <div class="d-flex justify-content-between align-items-center mb-3" style="    padding-left: 50px;">
         <div class="col-12" style="margin-top: 30px;">
            <div class="col-5" style="float: left;">
                <h2 class="fw-bold">All Products</h2>
            </div>
            <div class="col-3" style="float: left;">
                <form action="/admin/products/add" method="get">
                    <button class="btn" type="submit"  style="height:38px;width:230px;background-color:black;color:white;margin-bottom: 10px;">Add New Product
                        <i class="fas fa-add"style="padding-left: 10px; "></i></button>
                </form>
                
            </div>
            <div class="col-4" style="float: left;">
                <form method="GET" action="/admin/products" class="d-flex gap-2 justify-content-end mb-3" style="float:right;padding-right: 50px;margin-bottom: 20px;">
                    <input 
                        type="text" 
                        name="search" 
                        value="<%= search %>" 
                        class="form-control rounded-pill ps-4 pe-5" 
                        placeholder="Search here" 
                        style="width: 240px; height: 38px;"
                    >
                
                    <button type="submit"  style="height:38px;width:100px;background-color:black;color:white">Search
                        <i class="fas fa-search"style="padding-left: 10px; "></i></button>
                
                    <% if (search) { %>
                        <a href="/admin/products" class="btn btn-outline-secondary" style="height: 38px;">Clear</a>
                    <% } %>
                </form>
            </div>
         </div>
           
</div>
         


     <!-- Table -->
     <div class="table-responsive rounded-4 shadow-sm" >
         <table class="table align-middle text-center table-bordered mb-0" style="width: 98%;">
             <thead class="text-white" style="background-color: #000;">
                 <tr>
                    <th>Sl.No</th>
                     <th>Product Name</th>
                     <th>Image</th>
                     <th>Category</th>
                     <th>Brand</th>
                     <th>Sale Price</th>
                     <th>Status</th>
                     <th>Actions</th>
                     <th>Delete</th>
                     <th>Varients</th>
                 </tr>
             </thead>
             <tbody>
                 <%for( let i=0; i < data.length; i++){%>
                     <tr>
                        <td><%= (currentPage - 1) * 5 + i + 1 %></td>
                         <td class="d-flex align-items-center gap-2 justify-content-center py-3">
                             <%=data[i].productName%>
                         </td>
                         <td>
                            <% if (data[i].productImage && data[i].productImage.length > 0) { %>
                              <img src="<%= data[i].productImage[0] %>" alt="Product Image" style="height: 80px; width: 80px; object-fit: cover; border-radius: 8px;">
                            <% } else { %>
                              <span>No image</span>
                            <% } %>
                          </td>
                          
                         <td><%=data[i].categoryData.name%></td>
                         <td><%=data[i].brand%></td>
                         <td>₹ <%=data[i].salePrice%></td>

                         <td>
                            <%if(data[i].status === "Available"){%>
                                <i style="color: green ;"><%=data[i].status%></i>
                             <%}else{%>
                                <i style="color: red ;"><%=data[i].status%></i>
                                 <%}%>
                         </td>

                         <td>
                             <button style="background-color:rgb(54, 120, 81);color:white" class="btn view-btn"
                             data-product='<%- JSON.stringify(data[i]) %>'>Edit / View Details</button>
                         </td>
                         <td>
                            <button style="height:38px;width:100px;background-color:red;color:white" class="btn btn-success del-btn" onclick="confirmDelete('<%= data[i]._id %>')">Delete</button>
                        </td>
                        <td>
                            <form action="/admin/varients" method="GET">
                                <input type="hidden" name="productId" value="<%= data[i]._id %>">
                                <input type="hidden" name="productName" value="<%= data[i].productName %>">
                                <button style="background-color:rgb(9, 70, 86);color:white" class="btn btn-success">
                                  Add / View Varients
                                </button>
                              </form>
                        </td>
                     </tr>
                     <%}%>
             </tbody>
         </table>


         <nav class="mt-3 d-flex justify-content-center">
             <ul class="pagination">
                 <% for (let i = 1; i <= totalPages; i++) { %>
                     <li class="page-item <%= currentPage == i ? 'active' : '' %>">
                         <a class="page-link" href="/admin/products?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
                     </li>
                 <% } %>
             </ul>
         </nav>

         


     
 </div>


 <script>
  const allCategories = <%- JSON.stringify(categories || []) %>;
</script>

 
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

 <script>
     document.addEventListener('DOMContentLoaded', function () {


         const viewButtons = document.querySelectorAll('.view-btn');
    viewButtons.forEach(button => {
        button.addEventListener('click', function () {
            const product = JSON.parse(this.dataset.product);

            const imageGallery = product.productImage.map(img =>
                `<img src="${img}" style="height:185px;width:185px;object-fit:cover;border-radius:8px;margin:4px;">`
            ).join('');

            const categoryOptions = allCategories.map(cat => {
  const selected = cat.name === (product.categoryData?.name || '') ? 'selected' : '';
  return `<option value="${cat.name}" ${selected}>${cat.name}</option>`;
}).join('');


            Swal.fire({
                title: 'Product Details',
    width: '900px', // Wider box
    customClass: {
        popup: 'custom-swal-popup',
        confirmButton: 'custom-swal-confirm',
        cancelButton: 'custom-swal-cancel'
    },
                    html: `
                    <div style="display: flex; flex-direction: column; gap: 16px;">

<!-- Product Name - full width -->
<div style="width: 95%;">
  <label>Product Name:</label><br>
  <input id="productName" class="swal2-input" value="${product.productName}" style="width: 100%;">
</div>

<!-- Description - full width -->
<div style="width: 95%;">
  <label>Description:</label><br>
  <textarea id="description" class="swal2-textarea" style="width: 100%; height: 80px;">${product.description}</textarea>
</div>


<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; justify-content: center;">
        ${imageGallery}
      </div>

<!-- Two-column grid for rest -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
 
    <div>
  <label>Category:</label><br>
  <select id="category" class="swal2-input" style="width: 80%;">
    ${categoryOptions}
  </select>
</div>

  

  <div>
    <label>Brand:</label><br>
    <input id="brand" class="swal2-input" style="width:80%" value="${product.brand}">
  </div>

  <div>
    <label>Base Price:</label><br>
    <input id="basePrice" class="swal2-input" style="width:80%" value="${product.basePrice}">
  </div>

  <div>
    <label>Sale Price:</label><br>
    <input id="salePrice" class="swal2-input" style="width:80%" value="${product.salePrice}">
  </div>

  <div>
    <label>Status:</label><br>
    <input id="status" class="swal2-input" style="width:80%" value="${product.status}" disabled>
  </div>

  <div>
    <label>Blocked:</label><br>
    <input id="blocked" class="swal2-input" style="width:80%" value="${product.isBlocked ? 'Yes' : 'No'}" disabled>
  </div>

</div>


</div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save',
                cancelButtonText: 'Close',
                preConfirm: () => {
                    return {
                        productName: document.getElementById('productName').value,
                        description: document.getElementById('description').value,
                        category: document.getElementById('category').value,
                        brand: document.getElementById('brand').value,
                        basePrice: document.getElementById('basePrice').value,
                        salePrice: document.getElementById('salePrice').value,
                        status: document.getElementById('status').value,
                        _id: product._id
                    };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    fetch('/admin/products/update', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(result.value)
                    }).then(res => res.json()).then(response => {
                        if (response.success) {
                            Swal.fire('Updated!', 'Product updated successfully', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Error', response.message || 'Update failed', 'error');
                        }
                    });
                }
            });


            
            setTimeout(() => {
      const imageGalleryDiv = document.getElementById('imageGallery');
      const deleteButtons = document.querySelectorAll('.delete-img-btn');

      deleteButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          const updatedImages = [...product.productImage];
          updatedImages.splice(index, 1);

          // Re-render gallery
          const newGallery = updatedImages.map((img, idx) => `
            <div style="position: relative; display: inline-block;">
              <img src="${img}" 
                   style="height: 80px; width: 80px; object-fit: cover; border-radius: 8px; margin: 4px;" 
                   data-index="${idx}">

              <button class="delete-img-btn" 
                      data-index="${idx}" 
                      style="position: absolute; top: -6px; right: -6px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">
                ×
              </button>
            </div>
          `).join('');

          imageGalleryDiv.innerHTML = newGallery;
          product.productImage = updatedImages;
        });
      });
    }, 100);


        });
    });
 
    
     });

     function confirmDelete(id) {
  Swal.fire({
    title: 'Are you sure?',
    text: "You want to delete this product?",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#aaa',
    confirmButtonText: 'Yes, delete it!'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/products/delete/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        }
      }).then(res => res.json()).then(response => {
        if (response.success) {
          Swal.fire('Deleted!', 'Product deleted successfully.', 'success')
            .then(() => location.reload());
        } else {
          Swal.fire('Error', response.message || 'Delete failed', 'error');
        }
      });
    }
  });
}


        </script>


        <% if (typeof msg !=='undefined' && msg) { %>
            <script>
                Swal.fire({
                    icon: "<%= msg.includes('success') ? 'success' : 'error' %>",
                    title: "<%= msg %>",
                    timer: 2000,
                    showConfirmButton: false
                });
            </script>
            <% } %>


