<%-include("../../views/partials/admin/main") %>



  <style>
    img:hover {
      transform: scale(2);
      transition: 0.3s;
    }

    .swal2-input,
    .swal2-textarea {
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .file-label {
      display: inline-block;
      background-color: #333;
      color: white;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .file-label input[type="file"] {
      display: none;
    }

    #cropperImage {
      width: 100%;
      max-height: 400px;
      display: block;
    }

    #cropperModal {
      z-index: 100000;
      /* or higher */
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.min.css">
  <script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>


  <div class="container-fluid" style="width:110% ;">
    <div class="d-flex justify-content-between align-items-center mb-3" style="    padding-left: 50px;">
      <div class="col-12" style="margin-top: 30px;">
        <div class="col-5" style="float: left;">
          <h2 class="fw-bold">All Products</h2>
        </div>
        <div class="col-3" style="float: left;">
          <form action="/admin/products/add" method="get">
            <button class="btn" type="submit"
              style="height:38px;width:230px;background-color:black;color:white;margin-bottom: 10px;">Add New Product
              <i class="fas fa-add" style="padding-left: 10px; "></i></button>
          </form>

        </div>
        <div class="col-4" style="float: left;">
          <form method="GET" action="/admin/products" class="d-flex gap-2 justify-content-end mb-3"
            style="float:right;padding-right: 50px;margin-bottom: 20px;">
            <input type="text" name="search" value="<%= search %>" class="form-control rounded-pill ps-4 pe-5"
              placeholder="Search here" style="width: 240px; height: 38px;">

            <button type="submit" style="height:38px;width:100px;background-color:black;color:white">Search
              <i class="fas fa-search" style="padding-left: 10px; "></i></button>

            <% if (search) { %>
              <a href="/admin/products" class="btn btn-outline-secondary" style="height: 38px;">Clear</a>
              <% } %>
          </form>
        </div>
      </div>

    </div>



    <!-- Table -->
    <div class="table-responsive rounded-4 shadow-sm">
      <table class="table align-middle text-center table-bordered mb-0" style="width: 98%;">
        <thead class="text-white" style="background-color: #000;">
          <tr>
            <th>Sl.No</th>
            <th>Product Name</th>
            <th>Image</th>
            <th>Category</th>
            <th>Brand</th>
            <th>Sale Price</th>
            <th>Status</th>
            <th>Actions</th>
            <th>Delete</th>
            <th>Variants</th>
          </tr>
        </thead>
        <tbody>
          <%for( let i=0; i < data.length; i++){%>
            <tr>
              <td>
                <%= (currentPage - 1) * 5 + i + 1 %>
              </td>
              <td class="d-flex align-items-center gap-2 justify-content-center py-3">
                <%=data[i].productName%>
              </td>
              <td>
                <% if (data[i].productImage && data[i].productImage.length> 0) { %>
                  <img src="<%= data[i].productImage[0] %>" alt="Product Image"
                    style="height: 80px; width: 80px; object-fit: cover; border-radius: 8px;">
                  <% } else { %>
                    <span>No image</span>
                    <% } %>
              </td>

              <td>
                <%=data[i].categoryData.name%>
              </td>
              <td>
                <%=data[i].brand%>
              </td>
              <td>₹ <%=data[i].salePrice%>
              </td>

              <td>
                <span class="badge <%= data[i].isBlock ? 'bg-danger' : 'bg-success' %> px-3 py-1 rounded-pill">
                  <%= data[i].isBlock ? 'Blocked' : 'Active' %>
                </span>
              </td>

              <td>
                <button style="background-color:rgb(54, 120, 81);color:white" class="btn view-btn"
                  data-product='<%- JSON.stringify(data[i]) %>' >View</button>
              </td>
              <td>
                <form action="/admin/products/edit" method="get">
                  <input type="hidden" name="id" value="<%= data[i]._id %>">
                  <button style="height:38px;width:100px;background-color:#6e0404;color:white;margin-bottom: 10px;"
                    class="btn btn-success del-btn">Edit</button>
                </form>

                <% if (!data[i].isBlock) { %>
                  <button class="btn btn-danger toggle-btn" data-id="<%= data[i]._id %>" data-block="true">Delete</button>
                <% } else { %>
                  <button class="btn btn-success toggle-btn" data-id="<%= data[i]._id %>" data-block="false">Restore</button>
                <% } %>
              </td>
              <td>
                <form action="/admin/variants" method="GET">
                  <input type="hidden" name="productId" value="<%= data[i]._id %>">
                  <input type="hidden" name="productName" value="<%= data[i].productName %>">
                  <button style="background-color:rgb(9, 70, 86);color:white" class="btn btn-success">
                    Add / View Variants
                  </button>
                </form>
              </td>

            </tr>
            <%}%>
        </tbody>
      </table>


      <nav class="mt-3 d-flex justify-content-center">
        <ul class="pagination">
          <% for (let i=1; i <=totalPages; i++) { %>
            <li class="page-item <%= currentPage == i ? 'active' : '' %>">
              <a class="page-link" href="/admin/products?page=<%= i %><%= search ? '&search=' + search : '' %>">
                <%= i %>
              </a>
            </li>
            <% } %>
        </ul>
      </nav>







    </div>


    <script>
      const allCategories = <% - JSON.stringify(categories || []) %>;
    </script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <!-- //view button click// -->
<script>
   document.addEventListener('DOMContentLoaded', function () {
  const viewButtons = document.querySelectorAll('.view-btn');

  viewButtons.forEach(button => {
    button.addEventListener('click', function () {
      const product = JSON.parse(this.dataset.product);

      // Horizontal image gallery
      const imageGallery = `
        <div style="
          display: flex;
          gap: 10px;
          flex-wrap: nowrap;
          overflow-x: auto;
          padding: 10px 0;
        ">
          ${product.productImage.map(img => `
            <div style="
              flex: 0 0 auto;
              text-align: center;
              border: 1px solid #ddd;
              border-radius: 8px;
              padding: 5px;
              background: #f9f9f9;
            ">
              <img src="${img}" 
                   style="height: 150px; width: 150px; object-fit: cover; border-radius: 8px;">
            </div>
          `).join('')}
        </div>
      `;

      Swal.fire({
        title: `<h2 style="margin-bottom: 10px;">${product.productName}</h2>`,
        width: '900px',
        html: `
          <div style="
            text-align: left;
            font-size: 14px;
            line-height: 1.6;
            max-height: 70vh;
            overflow-y: auto;
          ">
            <p><strong>Description:</strong> ${product.description}</p>
            <p><strong>Category:</strong> ${product.categoryData?.name || ''}</p>
            <p><strong>Brand:</strong> ${product.brand}</p>
            <p><strong>Base Price:</strong> ₹${product.basePrice}</p>
            <p><strong>Sale Price:</strong> ₹${product.salePrice}</p>
            <p><strong>Status:</strong> ${product.status}</p>
            <p><strong>Blocked:</strong> ${product.isBlocked ? 'Yes' : 'No'}</p>
            <hr style="margin: 15px 0;">
            <h4 style="margin-bottom: 10px;">Product Images</h4>
            ${imageGallery}
          </div>
        `,
        showCancelButton: false,
        confirmButtonText: 'Close',
        confirmButtonColor: '#3085d6',
        customClass: {
          popup: 'swal-wide'
        }
      });
    });
  });

  //////////////////////////////////////////////////////////////////////////////////

  const toggleButtons = document.querySelectorAll('.toggle-btn');

toggleButtons.forEach(button => {
  button.addEventListener('click', function () {
    const productId = this.dataset.id;
    const blockValue = this.dataset.block === "true";

    Swal.fire({
      title: blockValue ? 'Delete Product?' : 'Restore Product?',
      text: blockValue 
        ? "This product will be blocked (soft deleted)." 
        : "This product will be restored and active again.",
      icon: blockValue ? 'warning' : 'question',
      showCancelButton: true,
      confirmButtonColor: blockValue ? '#d33' : '#28a745',
      cancelButtonColor: '#3085d6',
      confirmButtonText: blockValue ? 'Yes, delete' : 'Yes, restore'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/admin/products/${productId}/block`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isBlock: blockValue })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) location.reload();
        });
      }
    });
  });
});

});
  </script>    


    <% if (typeof msg !=='undefined' && msg) { %>
      <script>
        Swal.fire({
          icon: "<%= msg.includes('success') ? 'success' : 'error' %>",
          title: "<%= msg %>",
          timer: 2000,
          showConfirmButton: false
        });
      </script>
      <% } %>



        <!-- Cropper Modal -->
        <div id="cropperModal"
          style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000000cc; z-index:9999; justify-content:center; align-items:center;">
          <div style="background:white; padding:20px; border-radius:10px; max-width:500px;">
            <h5>Crop Image</h5>
            <img id="cropperImage" style="max-width:100%; max-height:400px;">
            <div style="margin-top:10px; text-align:right;">
              <button id="cancelCrop" class="btn btn-secondary btn-sm">Cancel</button>
              <button id="applyCrop" class="btn btn-success btn-sm">Crop</button>
            </div>
          </div>
        </div>