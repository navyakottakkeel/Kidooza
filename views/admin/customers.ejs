<%-include("../../views/partials/admin/main") %>

    <div class="container-fluid" style="width:100% ;">
        <div class="d-flex justify-content-between align-items-center mb-3" style="    padding-left: 50px;">
            <div style="    width: 50%;margin-top: 30px;">
                <h2 class="fw-bold">Customer</h2>
            </div>

            <form method="GET" action="/admin/users" class="d-flex gap-2 justify-content-end mb-3"
                style="float:right;padding-right: 50px;margin-bottom: 20px;">
                <input type="text" name="search" value="<%= search %>" class="form-control rounded-pill ps-4 pe-5"
                    placeholder="Search here" style="width: 240px; height: 38px;">

                <button type="submit" style="height:38px;width:100px;background-color:black;color:white">Search
                    <i class="fas fa-search" style="padding-left: 10px; "></i></button>

                <% if (search) { %>
                    <a href="/admin/users" class="btn btn-outline-secondary" style="height: 38px;">Clear</a>
                    <% } %>
            </form>
        </div>

        <!-- Table -->
        <div class="table-responsive rounded-4 shadow-sm">
            <table class="table align-middle text-center table-bordered mb-0" style="width: 100%;">
                <thead class="text-white" style="background-color: #000;">
                    <tr>
                        <th>Sl.No</th>
                        <th>Customer</th>
                        <th>Email ID</th>
                        <!-- <th>Orders</th>
                        <th>Balance</th> -->
                        <th>Status</th>
                        <th>Actions</th>
                        <th>View</th>
                    </tr>
                </thead>
                <tbody>
                    <%for( let i=0; i < data.length; i++){%>
                        <tr>
                            <td>
                                <%= (currentPage - 1) * 6 + i + 1 %>
                            </td>
                            <td class="d-flex align-items-center gap-2 justify-content-center py-3">
                                <%=data[i].name%>
                            </td>
                            <td>
                                <%=data[i].email%>
                            </td>
                            <!-- <td>73</td>
                            <td>₹450</td> -->
                            <td>
                                <span class="badge bg-success-subtle text-success px-3 py-1 rounded-pill">
                                    <%if(data[i].isBlocked===false){%>
                                        <i style="color: green ;">Active</i>
                                        <%}else{%>
                                            <i style="color:red ;">Blocked</i>
                                            <%}%>
                                </span>
                            </td>
                            <td>
                                <span>
                                    <%if(data[i].isBlocked===false){%>
                                        <button style="height:38px;width:100px;background-color:red;color:white"
                                            class="block-btn" data-id="<%= data[i]._id %>">
                                            Block
                                        </button>

                                        <%}else{%>
                                            <button style="height:38px;width:100px;background-color:green;color:white"
                                                class="unblock-btn" data-id="<%= data[i]._id %>">Unblock</button>
                                            <%}%>
                                </span>
                            </td>
                            <td>
                                <button data-user='<%- JSON.stringify(data[i]) %>'
                                    style="height:38px;width:100px;background-color:black;color:white"
                                    class="btn view-btn">View </button>
                            </td>
                        </tr>
                        <%}%>
                </tbody>
            </table>


            <nav class="mt-3 d-flex justify-content-center">
                <ul class="pagination">
              
                  <% 
                    const maxVisible = 3;
                    const start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                    const end = Math.min(totalPages, start + maxVisible - 1);
                    const adjustedStart = Math.max(1, end - maxVisible + 1);
                  %>
              
                  <!-- Prev Button -->
                  <li class="page-item <%= currentPage <= 1 ? 'disabled' : '' %>">
                    <a class="page-link"
                       href="/admin/users?page=<%= currentPage - 1 %><%= search ? '&search=' + search : '' %>">
                       Prev
                    </a>
                  </li>
              
                  <!-- Page Numbers -->
                  <% for (let i = adjustedStart; i <= end; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                      <a class="page-link"
                         href="/admin/users?page=<%= i %><%= search ? '&search=' + search : '' %>">
                         <%= i %>
                      </a>
                    </li>
                  <% } %>
              
                  <!-- Next Button -->
                  <li class="page-item <%= currentPage >= totalPages ? 'disabled' : '' %>">
                    <a class="page-link"
                       href="/admin/users?page=<%= currentPage + 1 %><%= search ? '&search=' + search : '' %>">
                       Next
                    </a>
                  </li>
              
                </ul>
              </nav>
              
        </div>



        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const blockButtons = document.querySelectorAll('.block-btn');
                const unblockButtons = document.querySelectorAll('.unblock-btn');

                blockButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const userId = this.dataset.id;
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You want to block this customer",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, block'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = `/admin/blockCustomer?id=${userId}`;
                            }
                        });
                    });
                });

                unblockButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const userId = this.dataset.id;
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You want to unblock this customer",
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#28a745',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, unblock'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = `/admin/unblockCustomer?id=${userId}`;
                            }
                        });
                    });
                });
            });
        </script>


        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const viewButtons = document.querySelectorAll('.view-btn');

                viewButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const user = JSON.parse(this.dataset.user);

                        // Horizontal image gallery


                        Swal.fire({
                            title: `<h2 style="margin-bottom: 10px;">${user.name}</h2>`,
                            width: '900px',
                            html: `
          <div style="
            text-align: left;
            font-size: 14px;
            line-height: 1.6;
            max-height: 70vh;
            overflow-y: auto;
          ">
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Category:</strong> ${user.categoryData?.name || ''}</p>
            <p><strong>Phone:</strong> ${user.phone}</p>
            <p><strong>Blocked:</strong> ${user.isBlocked}</p>
            <p><strong>Balance:</strong> ₹${user.wallet}</p>
            
            <hr style="margin: 15px 0;">
            
          </div>
        `,
                            showCancelButton: false,
                            confirmButtonText: 'Close',
                            confirmButtonColor: '#3085d6',
                            customClass: {
                                popup: 'swal-wide'
                            }
                        });
                    });
                });
            });

        </script>