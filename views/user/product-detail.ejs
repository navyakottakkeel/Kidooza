
<%-include("../../views/partials/user/header") %>


<style>
    .thumbnail-img {
      width: 80px;
      margin-bottom: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border 0.3s;
    }
  
    .thumbnail-img.active {
      border: 2px solid #f27c1f; /* Highlight color */
    }

    .zoom-container {
  position: relative;
  width: 480px;
  height: auto;
  overflow: hidden;
}

.zoom-image {
  width: 100%;
  display: block;
}

.zoom-lens {
  position: absolute;
  border: 1px solid #000;
  width: 200px;
  height: 200px;
  visibility: hidden;
  pointer-events: none;
  background-repeat: no-repeat;
  background-size: 800px 800px; /* Should be double the original for smoother zoom */
  z-index: 10;
}
.breadcrumbs a {
  color: #007bff;
  text-decoration: none;
}
.breadcrumbs span {
  color: #333;
}
.product-rating {
    font-size: 1.1rem;
    margin-bottom: 10px;
    color: #f5a623; /* golden yellow */
  }

  .product-rating .review-count {
    color: #555;
    font-size: 0.95rem;
    margin-left: 8px;
  }

  .review-section {
    border-top: 1px solid #ccc;
    margin-top: 20px;
    padding-top: 15px;
  }

  .review {
    background: #f8f8f8;
    padding: 12px;
    margin-top: 10px;
    border-radius: 5px;
  }

  .review strong {
    font-size: 1rem;
    display: inline-block;
    margin-bottom: 4px;
  }

  .review span {
    color: #f5a623;
    margin-left: 5px;
  }
  .product-price {
    font-size: 1.2rem;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .selling-price {
    font-weight: bold;
    color: #222;
    font-size: 1.4rem;
  }

  .original-price {
    color: #999;
    font-size: 1rem;
  }

  .discount-tag {
    background-color:#5d8355;
    color: #fff;
    padding: 2px 8px;
    font-size: 0.85rem;
    border-radius: 5px;
  }
  .size-selection-wrapper {
    margin: 20px 0;
  }

  .size-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .size-chart-link {
    font-size: 0.9rem;
    color: #f16522; /* Orange like in screenshot */
    text-decoration: none;
  }

  .size-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .size-btn {
    border: 1px solid #ccc;
    border-radius: 25px;
    padding: 8px 16px;
    font-size: 0.95rem;
    background-color: white;
    cursor: pointer;
    transition: 0.2s ease-in-out;
    min-width: 70px;
    text-align: center;
  }

  .size-btn.selected {
    border-color: #f16522;
    background-color: #fff2eb;
    font-weight: 600;
    color: #f16522;
  }

  .size-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .quick-actions {
    margin: 15px 0;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .action-btn {
    background: none;
    border: none;
    color: #555;
    font-size: 1.15rem;
    cursor: pointer;
  }

  /* Quantity Selector */
  .quantity-selector {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
  }

  .quantity-selector button {
    background: #eee;
    border: none;
    padding: 5px 10px;
    font-size: 1.2rem;
    cursor: pointer;
  }

  .quantity-selector input {
    width: 40px;
    text-align: center;
    border: 1px solid #ccc;
    font-size: 1rem;
    border-radius: 5px;
  }

 
  .cart-actions button {
    display: block;
    width: 60%;
    padding: 12px;
    margin: 10px 0;
    font-size: 1rem;
    border: none;
    border-radius: 25px;
    cursor: pointer;
  }

  .btn-add-to-cart {
    background-color: #5d8255;
    color: #fff;
  }

  .btn-buy-now {
    background-color: #fa5d63; 
    color: #fff;
  }

  .recommended-section {
    margin-top: 60px;
    padding: 20px;
    background: #fefefe;
  }

  .recommended-section h2 {
    font-family: 'Caveat', cursive;
    font-size: 2rem;
    margin-bottom: 20px;
    color: #5c4c32;
  }

  .recommended-products {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }

  .product-card {
    background: #fff;
    border-radius: 12px;
    width: 180px;
    text-align: center;
    padding: 10px;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .image-wrapper {
    position: relative;
  }

  .product-card img {
    width: 100%;
    height: auto;
    border-radius: 10px;
  }

  .discount-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #1d0e49;
    color: #fff;
    padding: 2px 6px;
    font-size: 0.75rem;
    border-radius: 4px;
  }

  .product-name {
    margin: 10px 0 5px;
    font-size: 0.95rem;
    color: #333;
  }

  .product-price {
    font-weight: bold;
    color: #e84a5f;
  }

  .original-price {
    font-weight: normal;
    text-decoration: line-through;
    font-size: 0.85rem;
    color: #888;
    margin-left: 5px;
  }
  .colour-options {
  display: flex;
  gap: 10px;
  margin-top: 5px;
}

.colour-circle {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: transform 0.2s, border-color 0.2s;
}

.colour-circle.selected {
  border-color: #f16522; /* highlight */
  transform: scale(1.1);
}

.colour-circle:hover {
  transform: scale(1.05);
}
.quantity-selector {
    display: inline-flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 25px;
    overflow: hidden;
    background-color: white;
    font-size: 18px;
    margin-bottom: 15px;
    height: 40px;
}

.quantity-selector button {
    background: none;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 20px;
    color: #333;
}

.quantity-selector span {
    padding: 0 14px;
    font-size: 16px;
    min-width: 30px;
    text-align: center;
}

.wishlist-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }

    .wishlist-btn i {
      font-size: 1.2rem;
      color: #dc3545
    }

    .wishlist-btn.active {
      background-color: #dc3545;
    }

    .wishlist-btn.active i {
      color: white;
    }

  </style>
  


<div style="margin-top: 170px;">
     
    <div class="container my-5">
        
    <div class="breadcrumbs">
        <a href="/">Home</a> /
        <a href="/boys">Boys</a> /
        <span><%= product.productName %></span>
      </div>
      <br>
      <div class="row">
        <div class="col-md-6">
            <div style="display: flex; gap: 20px;">
                <!-- Thumbnail list -->
                <div id="thumbnailsContainer">
                  <% product.productImage.forEach((image, index) => { %>
                    <img src="<%= image %>"
                         class="thumbnail-img <%= index === 0 ? 'active' : '' %>"
                         data-index="<%= index %>"
                         onclick="changeMainImage(this, '<%= image %>')" /><br>
                  <% }); %>

                   
                </div>
                
                  
              
                <!-- Main Image -->
                <div>
                    <div class="zoom-container position-relative">
                        <img id="mainImage" src="<%= product.productImage[0] %>" class="zoom-image" alt="Product Image" />
                        <div class="zoom-lens" id="zoomLens"></div>

                        <% 
                        const isWishlistedMain = wishlistItems.some(w =>
                            w.productId === product._id.toString() &&
                            w.variantId === (product.defaultVariantId ? product.defaultVariantId.toString() : "")
                        );
                    %>
                    <button id="wishlistMainBtn"
                        class="wishlist-btn position-absolute top-0 end-0 m-2 <%= isWishlistedMain ? 'active' : '' %>"
                        data-product-id="<%= product._id %>"
                        data-variant-id="">
                        <i class="fa fa-heart"></i>
                    </button>


                      </div>
                      
                </div>
              </div>
                      </div>
        <div class="col-md-6">
          <h2><%= product.productName %></h2>
          <p><%= product.description %></p>

          <div class="product-rating">
            <span class="stars">★★★★☆</span> <!-- 4 out of 5 -->
            <span class="review-count">(2 review)</span>
          </div>

          

          <div class="product-price">
            <span class="selling-price">₹<%= product.salePrice %></span>
            
            <% if (product.basePrice  > product.salePrice) { %>
              <span class="original-price"><del>₹<%= product.basePrice %></del></span>
              <span class="discount-tag"><%= discountPercent %>% OFF</span>
            <% } %>
          </div>


          <% if (colours && colours.length > 0) { %>

            <div class="mt-3">
              <h5>Available Colours:</h5>
              <div class="colour-options">
                <% colours.forEach(function(colour, index) { %>
                  <div class="colour-circle <%= index === 0 ? 'selected' : '' %>"
                       style="background-color: <%= colour %>"
                       onclick="selectColour(this, '<%= colour %>')">
                  </div>
                <% }) %>
              </div>
              <input type="hidden" id="selectedColour" name="selectedColour" value="<%= colours[0] %>">
            </div>
            
    

            <div class="size-selection-wrapper">
                <div class="size-header">
                  <strong>Size</strong>
                </div>
                
                <div class="size-options">
                  <% sizes.forEach(function(size, index) { %>
                    <button type="button" class="size-btn <%= index === 0 ? 'selected' : '' %>" onclick="selectSize(this)">
                      <%= size %>
                    </button>
                  <% }) %>
                </div>
              
                <input type="hidden" id="selectedSize" name="selectedSize" value="<%= sizes[0] %>">
              </div>

              <div id="stock-info" class="font-semibold text-green-700" style="color: green;font-weight: bolder;font-family: cursive;"></div>
              <div id="stock-info2" class="font-semibold text-green-700" style="color: red;font-weight: bolder;font-family: cursive;"></div>



          <% } %>

          
          <!-- Add to Cart & Buy Now Buttons -->
          <div class="cart-actions">
            <form id="addToCartForm">
                <input type="hidden" name="productId" value="<%= product._id %>">
                <input type="hidden" name="variantId" id="variantIdInput" value="">
                <div class="quantity-selector">
                  <button type="button" id="qty-decrease">-</button>
                  <span id="quantityDisplay">1</span>
                  <input type="hidden" id="quantityInput" name="quantity" value="1">
                  <button type="button" id="qty-increase">+</button>
              </div><label for="" style="color: #5d8255;">#Maximum quantity is 5</label>
              
              
                <button type="submit" class="btn btn-primary btn-add-to-cart">Add to Cart</button>
            </form>
        </div>
        
          


          <div class="review-section">
            <h4>Customer Reviews</h4>
            <div class="review">
              <strong>John</strong> - <span>⭐⭐⭐⭐☆</span>
              <p>Great quality product, really satisfied with the material and fit!</p>

              <strong>Alen Thoms</strong> - <span>⭐⭐⭐⭐☆</span>
              <p>Great quality product, really satisfied with the material and fit!</p>

            </div>
          </div>

          

        </div>
      </div>


      <!-- Recommended Products Section -->
<div class="recommended-section">
    <h2>Recommended Products</h2>
    <div class="recommended-products">
      <% relatedProducts.forEach(prod => { %>
        <div class="product-card">
            <div class="image-wrapper">
                <% if (prod.productImage && prod.productImage.length > 0) { %>
                  <img src="<%= prod.productImage[0] %>" alt="<%= prod.productName %>">
                <% } else { %>
                  <img src="/images/default-product.jpg" alt="No Image">
                <% } %>
              
                <% if (discountPercent) { %>
                  <span class="discount-badge">OFF <%= discountPercent %>%</span>
                <% } %>
              </div>
              
          <p class="product-name"><%= prod.productName %></p>
          <p class="product-price">
            ₹<%= prod.salePrice %> 
            <span class="original-price">₹<%= prod.basePrice %></span>
          </p>
        </div>
      <% }) %>
    </div>
  </div>

  

    </div>    


</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const wishlistItems = <%- JSON.stringify(wishlistItems) %>;
</script>


<script>
  document.querySelectorAll('.wishlist-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const productId = this.dataset.productId;
      const variantId = this.dataset.variantId;

      // Check if user is logged in (server will pass this in res.locals.user)
      const isLoggedIn = <%= user ? 'true' : 'false' %>;

      if (!isLoggedIn) {
        Swal.fire({
          title: 'Login Required',
          text: 'You need to log in to add items to your wishlist.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Login',
          cancelButtonText: 'Cancel',
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/login'; // Redirect to login
          }
        });
        return; // Stop here if not logged in
      }

      // If logged in → proceed to add/remove from wishlist
      fetch('/wishlist/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId, variantId })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            if (data.action === "added") {
              this.classList.add('active');
            } else {
              this.classList.remove('active');
            }
          } else {
            alert(data.message || 'Wishlist update failed');
          }
        });
    });
  });


  ///////////////////////////////////////////////////////////////////////////////////////////


const variants = <%- JSON.stringify(variants) %>;


document.getElementById('addToCartForm').addEventListener('submit', (e) => {
    e.preventDefault(); // ⛔ Prevent page reload

    const productId = "<%= product._id %>";
    const variantId = findVariant(
        document.getElementById('selectedSize').value,
        document.getElementById('selectedColour').value
    )?._id || null;
    const quantity = parseInt(document.getElementById('quantityInput').value, 10);

    fetch('/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ productId, variantId, quantity })
    })
    .then(async res => {
    const data = await res.json();
    if (!res.ok) throw data; // pass server error object to catch
    return data;
})
.then(data => {
    Swal.fire('Added!', 'Product added to cart', 'success');
})
.catch(err => {
    if (err.error === 'Not logged in') {
        Swal.fire({
            title: 'Please log in to continue',
            text: 'You need to log in before adding items to your cart.',
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Login',
            cancelButtonText: 'Cancel'
        }).then(result => {
            if (result.isConfirmed) {
                window.location.href = '/login';
            }
        });
    } else {
        Swal.fire('Error', err.error || 'Something went wrong', 'error');
    }
});
});

//////////////////////////////////////////////////////////////////////////////////////////

let qty = 1;
const qtyDisplay = document.getElementById('quantityDisplay');
const qtyInput = document.getElementById('quantityInput');

document.getElementById('qty-decrease').addEventListener('click', () => {
    if (qty > 1) qty--;
    qtyDisplay.textContent = qty;
    qtyInput.value = qty;
});

document.getElementById('qty-increase').addEventListener('click', () => {
    qty++;
    qtyDisplay.textContent = qty;
    qtyInput.value = qty;
});


///////////////////////////////////////////////////////////////////////////////////////////////


function findVariant(size, colour) {
  return variants.find(v => v.size === size && v.colour === colour);
}

function updateStockDisplay(stock) {
  const stockInfo = document.getElementById('stock-info');
  const stockInfo2 = document.getElementById('stock-info2');

  if (stock > 0) {
    stockInfo.textContent = `In Stock: ${stock}`;
    stockInfo.style.color = 'green';
    stockInfo2.textContent = "";
  } else {
    stockInfo2.textContent = "Out of Stock";
    stockInfo2.style.color = 'red';
    stockInfo.textContent = "";
  }
}

///////////////////////////////////////////////////////////////////////////////////////////////


function updatePriceAndDiscount(variant) {
  if (!variant) return;

  const sellingPriceElem = document.querySelector('.selling-price');
  const originalPriceElem = document.querySelector('.original-price');
  const discountTagElem = document.querySelector('.discount-tag');

  const basePrice = variant.basePrice || 0;
  const salePrice = variant.salePrice || 0;

  sellingPriceElem.textContent = `₹${salePrice}`;

  if (basePrice > salePrice) {
    originalPriceElem.innerHTML = `<del>₹${basePrice}</del>`;
    const discountPercent = Math.round(((basePrice - salePrice) / basePrice) * 100);
    discountTagElem.textContent = `${discountPercent}% OFF`;
    discountTagElem.style.display = 'inline';
  } else {
    originalPriceElem.textContent = '';
    discountTagElem.textContent = '';
    discountTagElem.style.display = 'none';
  }
}

///////////////////////////////////////////////////////////////////////////////////////////////


function updateImagesForColour(colour) {
  const variant = variants.find(v => v.colour === colour);
  if (!variant || !variant.productImage || variant.productImage.length === 0) return;

  const mainImage = document.getElementById('mainImage');
  const zoomLens = document.getElementById('zoomLens');

  mainImage.src = variant.productImage[0];
  zoomLens.style.backgroundImage = `url('${variant.productImage[0]}')`;

  const thumbnailsContainer = document.getElementById('thumbnailsContainer');
  thumbnailsContainer.innerHTML = '';

  variant.productImage.forEach((imgUrl, index) => {
    const img = document.createElement('img');
    img.src = imgUrl;
    img.className = 'thumbnail-img' + (index === 0 ? ' active' : '');
    img.dataset.index = index;
    img.style.cursor = 'pointer';
    img.onclick = () => changeMainImage(img, imgUrl);
    thumbnailsContainer.appendChild(img);
  });
}

////////////////////////////////////////////////////////////////////////////////////////////////


function changeMainImage(clickedThumbnail, imageUrl) {
  const mainImage = document.getElementById('mainImage');
  mainImage.src = imageUrl;

  const zoomLens = document.getElementById('zoomLens');
  zoomLens.style.backgroundImage = `url('${imageUrl}')`;

  document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
  clickedThumbnail.classList.add('active');
}

//////////////////////////////////////////////////////////////////////////////////////////////


function selectSize(button) {

 
  document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');

  const selectedSize = button.innerText.trim();
  document.getElementById('selectedSize').value = selectedSize;

  const selectedColour = document.getElementById('selectedColour').value;

  const variant = findVariant(selectedSize, selectedColour);

  updateStockDisplay(variant ? variant.stock : 0);
  updatePriceAndDiscount(variant);

   if (variant) {
    updateWishlistButton(variant._id);
  }

 
}

//////////////////////////////////////////////

function updateWishlistButton(variantId) {
  if (!wishlistMainBtn) return;

  const isWishlisted = wishlistItems.some(
    w => w.productId === "<%= product._id.toString() %>" &&
         w.variantId === variantId
  );

  wishlistMainBtn.classList.toggle('active', isWishlisted);
  wishlistMainBtn.dataset.variantId = variantId;
}


///////////////////////////////////////////////////////////////////////////////////////////////


function selectColour(element, colour) {

  
  document.querySelectorAll('.colour-circle').forEach(c => c.classList.remove('selected'));
  element.classList.add('selected');

  document.getElementById('selectedColour').value = colour;

  const selectedSize = document.getElementById('selectedSize').value;

  const variant = findVariant(selectedSize, colour);

  updateStockDisplay(variant ? variant.stock : 0);
  updatePriceAndDiscount(variant);
  updateImagesForColour(colour);

  
  if (variant) {
    updateWishlistButton(variant._id);
  }
}

///////////////////////////////////////////////////////////////////////////////////////////////

window.addEventListener('DOMContentLoaded', () => {
  const defaultSize = document.getElementById('selectedSize').value;
  const defaultColour = document.getElementById('selectedColour').value;

  const variant = findVariant(defaultSize, defaultColour);

  updateStockDisplay(variant ? variant.stock : 0);
  updatePriceAndDiscount(variant);
  updateImagesForColour(defaultColour);
});

if (variant) {
    updateWishlistButton(variant._id);
  }

/////////////////////////////////////////////////////////////////////////////////////

const zoomContainer = document.querySelector('.zoom-container');
  const mainImage = document.getElementById('mainImage');
  const zoomLens = document.getElementById('zoomLens');

  mainImage.addEventListener('mouseenter', () => {
    zoomLens.style.visibility = 'visible';
    zoomLens.style.backgroundImage = `url('${mainImage.src}')`;
  });

  mainImage.addEventListener('mousemove', (e) => {
    const bounds = mainImage.getBoundingClientRect();
    const x = e.pageX - bounds.left - window.scrollX;
    const y = e.pageY - bounds.top - window.scrollY;

    const lensSize = zoomLens.offsetWidth / 2;

    let lensX = x - lensSize;
    let lensY = y - lensSize;

    if (lensX < 0) lensX = 0;
    if (lensY < 0) lensY = 0;
    if (lensX > bounds.width - zoomLens.offsetWidth) lensX = bounds.width - zoomLens.offsetWidth;
    if (lensY > bounds.height - zoomLens.offsetHeight) lensY = bounds.height - zoomLens.offsetHeight;

    zoomLens.style.left = `${lensX}px`;
    zoomLens.style.top = `${lensY}px`;

    const zoomLevel = 2;
    zoomLens.style.backgroundPosition = `-${x * zoomLevel - lensSize}px -${y * zoomLevel - lensSize}px`;
  });

  mainImage.addEventListener('mouseleave', () => {
    zoomLens.style.visibility = 'hidden';
  });

///////////////////////////////////////////////////////////////////////////////////////////


</script>



     

<%-include("../../views/partials/user/footer") %>
